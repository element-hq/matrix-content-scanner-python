[tox]
envlist = py, check_codestyle, check_types

# required for PEP 517 (pyproject.toml-style) builds
isolated_build = true

[testenv:py]

# As of twisted 16.4, trial tries to import the tests as a package (previously
# it loaded the files explicitly), which means they need to be on the
# pythonpath. Our sdist doesn't include the 'tests' package, so normally it
# doesn't work within the tox virtualenv.
#
# As a workaround, we tell tox to do install with 'pip -e', which just
# creates a symlink to the project directory instead of unpacking the sdist.
usedevelop=true

extras = dev

commands =
  python -m twisted.trial tests

[testenv:check_codestyle]

extras = dev

commands =
  flake8 matrix_content_scanner tests
  black --check --diff matrix_content_scanner tests
  isort --check-only --diff matrix_content_scanner tests

[testenv:check_types]

extras = dev

# The current version of python-olm that's on PyPI does not include a types marker.
# Ideally we'd just specify a custom pip install command that uses an --index-url that
# points to Olm's PyPI repo, but it looks like the packaging does not include py.typed in
# wheels. https://gitlab.matrix.org/matrix-org/olm/-/merge_requests/62 is an attempt at
# fixing this.
deps =
  git+https://gitlab.matrix.org/babolivier/olm.git@babolivier/py.typed_manifest#egg=python-olm&subdirectory=python

commands =
  mypy matrix_content_scanner tests
